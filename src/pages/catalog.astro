---
// src/pages/catalog.astro
export const prerender = false;
import Layout from "../layouts/Layout.astro";
import CamperCard from "../components/CamperCard.astro";
import Pagination from "../components/Pagination.astro";
import { fetchCampers } from "../lib/api";

const pageParam = Astro.url.searchParams.get("page");
const currentPage = Math.max(1, Number(pageParam) || 1);
const limit = 4;

const { items: campers, total } = await fetchCampers({
  page: currentPage,
  limit,
});
const totalPages = Math.ceil(total / limit);

// Перевіряємо, чи це запит від HTMX
const isHtmx = Astro.request.headers.get("hx-request") === "true";
---

{/* 1. Якщо це HTMX запит — віддаємо ТІЛЬКИ нутрощі */}
{
  isHtmx ? (
    <div id="catalog-container">
      <ul class="campers-list">
        {campers.map((camper) => (
          <li>
            <CamperCard camper={camper} />
          </li>
        ))}
      </ul>
      <Pagination
        currentPage={currentPage}
        totalPages={totalPages}
        baseUrl="/catalog"
      />
    </div>
  ) : (
    /* 2. Якщо це звичайний заїзд на сторінку — віддаємо все разом з Layout */
    <Layout title="Catalog">
      <section class="catalog-section">
        <div class="container">
          {/* Огортаємо в div з ID, який HTMX буде замінювати */}
          <div id="catalog-container">
            {campers.length > 0 ? (
              <ul class="campers-list">
                {campers.map((camper) => (
                  <li>
                    <CamperCard camper={camper} />
                  </li>
                ))}
              </ul>
            ) : (
              <div class="empty-state">
                <p>No campers found.</p>
              </div>
            )}

            <Pagination
              currentPage={currentPage}
              totalPages={totalPages}
              baseUrl="/catalog"
            />
          </div>
        </div>
      </section>
    </Layout>
  )
}

<style>
  .catalog-section {
    padding: 64px 0;
  }
  .container {
    max-width: 1440px;
    margin: 0 auto;
    padding: 0 64px;
  }
  .campers-list {
    display: flex;
    flex-direction: column;
    gap: 32px;
    margin-bottom: 40px;
  }
</style>
