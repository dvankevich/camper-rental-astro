---
// src/pages/catalog.astro
export const prerender = false;
import Layout from "../layouts/Layout.astro";
import CamperCard from "../components/CamperCard.astro";
import Pagination from "../components/Pagination.astro";
import Sidebar from "../components/Sidebar.astro";
import { fetchCampers } from "../lib/api";
import type { Camper } from "../types/camper";

const searchParams = Astro.url.searchParams;
const pageParam = searchParams.get("page");
const currentPage = Math.max(1, Number(pageParam) || 1);
const limit = 4;
const queryParams = Object.fromEntries(searchParams.entries());

const { items, total } = await fetchCampers({
  ...queryParams,
  page: currentPage,
  limit,
});

const campers: Camper[] = items;
const totalPages = Math.ceil(total / limit);
const isHtmx = Astro.request.headers.get("hx-request") === "true";
---

{
  isHtmx ? (
    /* 1. HTMX ВІДПОВІДЬ (Повертаємо тільки внутрішній контент) */
    /* Ми НЕ повертаємо тут Sidebar, тільки оновлений список */
    <>
      {campers.length > 0 ? (
        <ul class="campers-list">
          {campers.map((camper) => (
            <li>
              <CamperCard camper={camper} />
            </li>
          ))}
        </ul>
      ) : (
        <div class="empty-state">
          <p>No campers found.</p>
        </div>
      )}

      <Pagination
        currentPage={currentPage}
        totalPages={totalPages}
        baseUrl="/catalog"
      />
    </>
  ) : (
    /* 2. ПОВНЕ ЗАВАНТАЖЕННЯ (Layout + Grid) */
    <Layout title="Catalog">
      <section class="catalog-section">
        <div class="container">
          <div class="catalog-grid">
            {/* Ліва колонка (Сайдбар) */}
            <aside class="sidebar-wrapper">
              <Sidebar />
            </aside>

            {/* Права колонка (Контейнер для списку) */}
            {/* Важливо: hx-target в Sidebar має вказувати на цей ID */}
            <div id="catalog-container" class="content-wrapper">
              {campers.length > 0 ? (
                <ul class="campers-list">
                  {campers.map((camper) => (
                    <li>
                      <CamperCard camper={camper} />
                    </li>
                  ))}
                </ul>
              ) : (
                <div class="empty-state">
                  <p>No campers found.</p>
                </div>
              )}

              <Pagination
                currentPage={currentPage}
                totalPages={totalPages}
                baseUrl="/catalog"
              />
            </div>
          </div>
        </div>
      </section>
    </Layout>
  )
}

<style is:global>
  .catalog-section {
    padding: 64px 0;
  }

  /* Контейнер гріда */
  .catalog-grid {
    display: grid;
    /* Фіксована ширина сайдбару 360px + 1fr для контенту */
    grid-template-columns: 360px 1fr;
    gap: 64px;
    align-items: start;
    width: 100%;
  }

  /* Обгортка сайдбару */
  .sidebar-wrapper {
    width: 360px;
    flex-shrink: 0;
  }

  /* Обгортка контенту */
  .content-wrapper {
    min-width: 0; /* Важливо для гріда, щоб не розпирало */
  }

  .campers-list {
    display: flex;
    flex-direction: column;
    gap: 32px;
    margin-bottom: 40px;
    padding: 0;
    list-style: none;
  }

  /* Адаптивність: якщо екран менше 1200px, ставимо один під одного */
  @media (max-width: 1200px) {
    .catalog-grid {
      grid-template-columns: 1fr;
      gap: 32px;
    }
    .sidebar-wrapper {
      width: 100%;
    }
  }
</style>
