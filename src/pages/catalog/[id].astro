---
import Layout from "../../layouts/Layout.astro";
import { fetchCamperById } from "../../lib/api";
import type { Camper } from "../../types/camper";
import BookingForm from "../../components/BookingForm.astro";
import CamperHeader from "../../components/details/CamperHeader.astro";
import CamperGallery from "../../components/details/CamperGallery.astro";
import CamperFeatures from "../../components/details/CamperFeatures.astro";
import CamperReviews from "../../components/details/CamperReviews.astro";

const { id } = Astro.params;
const camper: Camper | null = await fetchCamperById(id as string);

if (!camper) return Astro.redirect("/catalog");

const {
  name,
  price,
  rating,
  location,
  description,
  gallery,
  reviews,
  form,
  length,
  width,
  height,
  tank,
  consumption,
  transmission,
  engine,
  AC,
  bathroom,
  kitchen,
  TV,
  radio,
  refrigerator,
  microwave,
  gas,
  water,
} = camper;

const features = [
  {
    condition: transmission,
    label: transmission.charAt(0).toUpperCase() + transmission.slice(1),
    icon: "transmission",
  },
  {
    condition: engine,
    label: engine.charAt(0).toUpperCase() + engine.slice(1),
    icon: "engine",
  },
  { condition: AC, label: "AC", icon: "ac" },
  { condition: bathroom, label: "Bathroom", icon: "bathroom" },
  { condition: kitchen, label: "Kitchen", icon: "kitchen" },
  { condition: TV, label: "TV", icon: "tv" },
  { condition: radio, label: "Radio", icon: "radio" },
  { condition: refrigerator, label: "Refrigerator", icon: "refrigerator" },
  { condition: microwave, label: "Microwave", icon: "microwave" },
  { condition: gas, label: "Gas", icon: "gas" },
  { condition: water, label: "Water", icon: "water" },
].filter((f) => f.condition);

const formatForm = (text: string) =>
  text
    .replace(/([A-Z])/g, " $1")
    .replace(/^./, (str) => str.toUpperCase())
    .trim();
---

<Layout title={name}>
  <main class="details-page">
    <div class="container">
      <CamperHeader camper={camper} />

      <CamperGallery gallery={gallery} name={name} />

      <section class="description-section">
        <p>{description}</p>
      </section>

      <div class="tabs-nav" role="tablist">
        <button class="tab-link active" data-tab="features">Features</button>
        <button class="tab-link" data-tab="reviews"
          >Reviews ({reviews.length})</button
        >
      </div>

      <div class="main-layout">
        <div class="content-left">
          <div id="features-content" class="tab-pane active">
            <CamperFeatures
              features={features}
              details={{
                Form: formatForm(form),
                Length: length,
                Width: width,
                Height: height,
                Tank: tank,
                Consumption: consumption,
              }}
            />
          </div>
          <div id="reviews-content" class="tab-pane">
            <CamperReviews reviews={reviews} />
          </div>
        </div>
        <aside class="booking-sidebar">
          <BookingForm />
        </aside>
      </div>
    </div>
  </main>
</Layout>

<style>
  .details-page {
    padding: 40px 0 80px;
    color: #101828;
  }

  .container {
    max-width: 1216px;
    margin: 0 auto;
    padding: 0 16px;
  }

  /* Description */
  .description-section {
    font-size: 18px;
    line-height: 1.5;
    color: #475467;
    margin-bottom: 44px;
  }

  /* TABS NAV */
  .tabs-nav {
    display: flex;
    gap: 40px;
    border-bottom: 1px solid rgba(16, 24, 40, 0.1);
    margin-bottom: 44px;
  }

  .tab-link {
    font-size: 20px;
    font-weight: 600;
    padding-bottom: 24px;
    background: none;
    border: none;
    cursor: pointer;
    position: relative;
    color: #101828;
  }

  .tab-link.active::after {
    content: "";
    position: absolute;
    bottom: -1px;
    left: 0;
    width: 100%;
    height: 5px;
    background-color: #e44848;
  }

  /* MAIN LAYOUT GRID */
  .main-layout {
    display: grid;
    grid-template-columns: 1fr 1.016fr;
    gap: 40px;
    align-items: stretch;
  }

  .content-left {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  /* Tab Panes */
  .tab-pane {
    display: none;
  }

  .tab-pane.active {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    height: 100%;
  }

  /* Sidebar */
  .booking-sidebar {
    display: flex;
    flex-direction: column;
    height: 100%;
  }
</style>

<script>
  function initTabs() {
    const tabs = document.querySelectorAll(".tab-link");
    const panes = document.querySelectorAll(".tab-pane");
    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        const target = tab.getAttribute("data-tab");
        tabs.forEach((t) => t.classList.remove("active"));
        panes.forEach((p) => p.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(`${target}-content`)?.classList.add("active");
      });
    });
  }
  initTabs();
  document.body.addEventListener("htmx:afterSwap", initTabs);
</script>
