---
import Layout from "../../layouts/Layout.astro";
import { fetchCamperById } from "../../lib/api";
import Icon from "../../components/Icon.astro";
import type { Camper } from "../../types/camper";
import BookingForm from "../../components/BookingForm.astro";
import FavoriteButton from "../../components/FavoriteButton.jsx";

const { id } = Astro.params;
const camper: Camper | null = await fetchCamperById(id as string);

if (!camper) return Astro.redirect("/catalog");

const {
  name,
  price,
  rating,
  location,
  description,
  gallery,
  reviews,
  form,
  length,
  width,
  height,
  tank,
  consumption,
  transmission,
  engine,
  AC,
  bathroom,
  kitchen,
  TV,
  radio,
  refrigerator,
  microwave,
  gas,
  water,
} = camper;

const features = [
  {
    condition: transmission,
    label: transmission.charAt(0).toUpperCase() + transmission.slice(1),
    icon: "transmission",
  },
  {
    condition: engine,
    label: engine.charAt(0).toUpperCase() + engine.slice(1),
    icon: "engine",
  },
  { condition: AC, label: "AC", icon: "ac" },
  { condition: bathroom, label: "Bathroom", icon: "bathroom" },
  { condition: kitchen, label: "Kitchen", icon: "kitchen" },
  { condition: TV, label: "TV", icon: "tv" },
  { condition: radio, label: "Radio", icon: "radio" },
  { condition: refrigerator, label: "Refrigerator", icon: "refrigerator" },
  { condition: microwave, label: "Microwave", icon: "microwave" },
  { condition: gas, label: "Gas", icon: "gas" },
  { condition: water, label: "Water", icon: "water" },
].filter((f) => f.condition);

const formatForm = (text: string) =>
  text
    .replace(/([A-Z])/g, " $1")
    .replace(/^./, (str) => str.toUpperCase())
    .trim();
---

<Layout title={name}>
  <main class="details-page">
    <div class="container">
      {/* 1. Header Section */}
      <section class="header">
        <h1>{name}</h1>
        <div class="meta-info">
          <div class="rating-location">
            <span class="rating">
              <Icon name="starfull" size={16} class="star-icon" />
              {rating} ({reviews.length} Reviews)
            </span>
            <span class="location">
              <Icon name="map" size={16} />
              {location}
            </span>
          </div>
          <div class="price-wrapper">
            <p class="price">€{price.toLocaleString("en-IN")}.00</p>
            <FavoriteButton
              client:only="preact"
              camper={camper}
              className="details-fav-btn"
            >
              <div slot="fallback"><Icon name="heart" size={24} /></div>
            </FavoriteButton>
          </div>
        </div>
      </section>

      {/* 2. Gallery Section */}
      <section class="gallery">
        {
          gallery.slice(0, 3).map((img) => (
            <div class="gallery-item">
              <img src={img.original} alt={name} />
            </div>
          ))
        }
      </section>

      {/* 3. Description Section */}
      <section class="description-section">
        <p>{description}</p>
      </section>

      {/* 4. Tabs Navigation (ЗВЕРХУ СІТКИ, як у React) */}
      <div class="tabs-nav" role="tablist">
        <button class="tab-link active" data-tab="features" role="tab"
          >Features</button
        >
        <button class="tab-link" data-tab="reviews" role="tab"
          >Reviews ({reviews.length})</button
        >
      </div>

      {/* 5. Main Layout Grid (Content + Sidebar) */}
      <div class="main-layout">
        <div class="content-left">
          <div id="features-content" class="tab-pane active">
            <div class="features-inner-card">
              <div class="badges-grid">
                {
                  features.map((f) => (
                    <div class="badge">
                      <Icon name={f.icon} size={20} />
                      <span>{f.label}</span>
                    </div>
                  ))
                }
              </div>

              <div class="details-block">
                <h3>Vehicle details</h3>
                <ul class="details-list">
                  <li><span>Form</span> <span>{formatForm(form)}</span></li>
                  <li><span>Length</span> <span>{length}</span></li>
                  <li><span>Width</span> <span>{width}</span></li>
                  <li><span>Height</span> <span>{height}</span></li>
                  <li><span>Tank</span> <span>{tank}</span></li>
                  <li><span>Consumption</span> <span>{consumption}</span></li>
                </ul>
              </div>
            </div>
          </div>

          <div id="reviews-content" class="tab-pane">
            <div class="reviews-list">
              {
                reviews.map((review) => (
                  <div class="review-item">
                    <div class="review-header">
                      <div class="avatar">{review.reviewer_name.charAt(0)}</div>
                      <div class="reviewer-info">
                        <p class="reviewer-name">{review.reviewer_name}</p>
                        <div class="stars">
                          {[...Array(5)].map((_, i) => (
                            <Icon
                              name="starfull"
                              size={16}
                              class={
                                i < review.reviewer_rating
                                  ? "star-active"
                                  : "star-empty"
                              }
                            />
                          ))}
                        </div>
                      </div>
                    </div>
                    <p class="review-comment">{review.comment}</p>
                  </div>
                ))
              }
            </div>
          </div>
        </div>

        {/* 6. Sidebar Right */}
        <aside class="booking-sidebar">
          <BookingForm />
        </aside>
      </div>
    </div>
  </main>
</Layout>

<style>
  .details-page {
    padding: 40px 0 80px;
    color: #101828;
  }
  .container {
    max-width: 1216px;
    margin: 0 auto;
    padding: 0 16px;
  }

  /* Header */
  .header h1 {
    font-size: 32px;
    font-weight: 600;
    margin-bottom: 10px;
  }
  .meta-info {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 28px;
  }
  .rating-location {
    display: flex;
    gap: 16px;
    font-size: 16px;
  }
  .rating {
    text-decoration: underline;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .star-icon {
    color: #ffc107;
  }
  .location {
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .price-wrapper {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .price {
    font-size: 32px;
    font-weight: 600;
  }

  /* Gallery */
  .gallery {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-bottom: 40px;
  }
  .gallery-item img {
    width: 100%;
    height: 310px;
    object-fit: cover;
    border-radius: 10px;
  }

  /* Description */
  .description-section {
    font-size: 18px;
    line-height: 1.5;
    color: #475467;
    margin-bottom: 44px;
  }

  /* TABS NAV */
  .tabs-nav {
    display: flex;
    gap: 40px;
    border-bottom: 1px solid rgba(16, 24, 40, 0.1);
    margin-bottom: 44px;
  }
  .tab-link {
    font-size: 20px;
    font-weight: 600;
    padding-bottom: 24px;
    background: none;
    border: none;
    cursor: pointer;
    position: relative;
    color: #101828;
  }
  .tab-link.active::after {
    content: "";
    position: absolute;
    bottom: -1px;
    left: 0;
    width: 100%;
    height: 5px;
    background-color: #e44848;
  }

  /* MAIN LAYOUT GRID */
  .main-layout {
    display: grid;
    /* Права колонка буде приблизно на 1.6% ширшою за ліву */
    grid-template-columns: 1fr 1.016fr;
    gap: 40px;
    align-items: stretch;
  }

  /* Content Left */
  .content-left {
    display: flex;
    flex-direction: column;
    /* Контейнер має займати всю доступну висоту */
    height: 100%;
  }

  /* Tab Panes */
  .tab-pane {
    display: none;
  }
  .tab-pane.active {
    /* ВИПРАВЛЕНО: робимо таб гнучким контейнером на всю висоту */
    display: flex;
    flex-direction: column;
    /* Змушуємо активний таб розтягуватися */
    flex-grow: 1;
    height: 100%;
  }

  /* ЛІВА КАРТКА (FEATURES) */
  .features-inner-card {
    background-color: #f7f7f7;
    padding: 40px;
    border-radius: 10px;
    /* ВИПРАВЛЕНО: Flexbox для керування внутрішнім простором */
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    height: 100%;
  }

  .badges-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    /* Прибираємо фіксований відступ, щоб margin-top: auto працював коректно */
    margin-bottom: 0;
  }

  .badge {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 18px;
    background-color: #f2f4f7;
    border-radius: 100px;
    font-size: 16px;
    font-weight: 500;
    color: #101828;
  }

  /* Vehicle Details */
  .details-block {
    /* ВИПРАВЛЕНО: margin-top: auto виштовхує блок до низу, створюючи пустий простір */
    margin-top: auto;
    padding-top: 44px; /* Мінімальна відстань, якщо контенту забагато */
  }

  .details-block h3 {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 24px;
    border-bottom: 1px solid rgba(16, 24, 40, 0.1);
    padding-bottom: 24px;
  }

  .details-list {
    list-style: none;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .details-list li {
    display: flex;
    justify-content: space-between;
    font-size: 18px;
    font-weight: 500;
  }

  /* Reviews */
  .reviews-list {
    display: flex;
    flex-direction: column;
    gap: 44px;
  }

  /* Sidebar */
  .booking-sidebar {
    display: flex;
    flex-direction: column;
    height: 100%;
  }
</style>

<script>
  function initTabs() {
    const tabs = document.querySelectorAll(".tab-link");
    const panes = document.querySelectorAll(".tab-pane");
    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        const target = tab.getAttribute("data-tab");
        tabs.forEach((t) => t.classList.remove("active"));
        panes.forEach((p) => p.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(`${target}-content`)?.classList.add("active");
      });
    });
  }
  initTabs();
  document.body.addEventListener("htmx:afterSwap", initTabs);
</script>
